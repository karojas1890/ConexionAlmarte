{% extends "layout.html" %}

{% block title %}Elegir Fecha{% endblock %}

{% block content %}
    <main class="main-content">
      

        <div class="progress-section">
            <div class="progress-title">Agendar cita</div>
            <div class="progress-steps">
                <div class="step completed">1</div>
                <div class="step-arrow">→</div>
                <div class="step active">2</div>
                <div class="step-arrow">→</div>
                <div class="step inactive">3</div>
            </div>
        </div>

        <div class="main">
            <div class="section-title">Fecha y Hora</div>
            <div class="section-subtitle">Selecciona cuándo te gustaría tener tu cita</div>

            <div class="service-summary">
                <div class="service-summary-text"  id="service-summary-text"></div>
            </div>
            <div class="date-section" >
                <div class="date-title">Selecciona la fecha</div>
                <div class="date-grid">
        
                </div>
           </div>

           <div class="time-section" style="overflow: auto;">
               <div class="time-title">Selecciona la hora</div>
               <div class="time-grid">
         
               </div>
            </div>

            <button class="continue-btn" 
                data-url="{{ url_for('routes.payment_summary') }}" 
                onclick="continueToPayment(this)">
                 Continuar
            </button>

        </div>

        
    </main>
    
<script src="{{ url_for('static', filename='js/selecte-datetime.js') }}"></script>
    <script>
document.addEventListener("DOMContentLoaded", () => {
    const summaryDiv = document.getElementById("service-summary-text");

    // Toma atos del localStorage
    const selectedService = localStorage.getItem('selectedServiceName'); 
    const selectedPrice = localStorage.getItem('selectedPrice'); 

    // covierte el monto a un nuemro valdo
    const precioNumero = parseFloat(selectedPrice);
    
    if (selectedService && !isNaN(precioNumero)) {
        summaryDiv.textContent = `${selectedService} - ₡${precioNumero.toLocaleString()}`;
    } else if (selectedService) {
        summaryDiv.textContent = `${selectedService} - ₡N/A`;
    } else {
        summaryDiv.textContent = "No has seleccionado un servicio aún";
    }
});


      document.addEventListener("DOMContentLoaded", () => {
    // carga la disponibilidad al iniciar
    fetchDisponibilidad();
});

function fetchDisponibilidad() {
    fetch(`{{ url_for('Citas.ObtenerDisponibilidad') }}`)
        .then(res => {
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return res.json();
        })
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            renderDisponibilidad(data);
        })
        .catch(err => console.error("Error al cargar disponibilidad:", err));
}

function renderDisponibilidad(data) {
    const dateGrid = document.querySelector(".date-grid");
    const timeGrid = document.querySelector(".time-grid");

    // Agrupar horarios por fecha
    const fechas = {};
    data.forEach(d => {
        if (d.estado !== 1) return; // Solo disponibles

       
        d.fechaCalendario = d.fecha;            
        d.horaInicioCalendario = d.hora_inicio; 
        d.horaFinCalendario = d.hora_fin;       

        if (!fechas[d.fecha]) fechas[d.fecha] = [];
        fechas[d.fecha].push(d);
    });

    dateGrid.innerHTML = "";
    timeGrid.innerHTML = "";

    const fechasArray = Object.keys(fechas).sort();

    // Crear botones de fecha
    fechasArray.forEach((fecha, i) => {
        const div = document.createElement("div");
        div.className = "date-option" + (i === 0 ? " selected" : "");
        div.dataset.fecha = fecha;
        div.textContent = new Date(fecha).toLocaleDateString("es-ES", {
            weekday: "short",
            day: "numeric",
            month: "long"
        });

        div.addEventListener("click", () => selectDate(div, fechas[fecha]));
        dateGrid.appendChild(div);
    });

    // Mostrar horas del primer día por defecto
    if (fechasArray.length > 0) renderHoras(fechas[fechasArray[0]]);
}

function selectDate(element, horarios) {
    document.querySelectorAll(".date-option").forEach(e => e.classList.remove("selected"));
    element.classList.add("selected");
    renderHoras(horarios);
}

function renderHoras(horarios) {
    const timeGrid = document.querySelector(".time-grid");
    timeGrid.innerHTML = "";

    horarios.sort((a, b) => a.hora_inicio.localeCompare(b.hora_inicio));

    horarios.forEach(h => {
        const div = document.createElement("div");
        div.className = "time-option";
        div.innerText = `${h.hora_inicio} - ${h.hora_fin}`;
        div.addEventListener("click", () => selectTime(div, h.id));
        timeGrid.appendChild(div);
    });
}

function selectTime(element, idDisponibilidad) {
    document.querySelectorAll(".time-option").forEach(e => e.classList.remove("selected"));
    element.classList.add("selected");

    // Guardar la disponibilidad seleccionada
    localStorage.setItem("idDisponibilidadSeleccionada", idDisponibilidad);
    
    
}

    </script>
    
{% endblock %}

