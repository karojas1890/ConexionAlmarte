{% extends "layout.html" %}

{% block title %}Pago{% endblock %}

{% block content %}
    <main class="main-content">  
    

        <div class="progress-section">
            <div class="progress-title">Agendar cita</div>
            <div class="progress-steps">
                <div class="step completed">1</div>
                <div class="step-arrow">‚Üí</div>
                <div class="step completed">2</div>
                <div class="step-arrow">‚Üí</div>
                <div class="step active">3</div>
            </div>
        </div>

        <div class="main">
            <button class="back-button" onclick="window.history.back()">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Volver
            </button>
            <div class="section-title">Resumen de tu cita</div>

            <div class="summary-card">
                <div class="summary-header" id="service-summary-text"></div>
                <div class="summary-row">
                    <span class="summary-label">Fecha</span>
                    <span class="summary-value" id="summary-date">No seleccionada</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Hora</span>
                    <span class="summary-value" id="summary-time">No seleccionada</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total</span>
                    <span class="summary-value" id="summary-price">‚Ç°0</span>
                </div>
            </div>

            <div class="payment-section">
                <div class="payment-title">M√©todo de pago</div>
                
                <div class="payment-option selected" onclick="selectPayment(this)">
                    <div class="payment-icon">üí≥</div>
                    <div class="payment-text">Tarjeta de cr√©dito o d√©bito</div>
                </div>

                <div class="payment-option" onclick="selectPayment(this)">
                    <div class="payment-icon">üè¶</div>
                    <div class="payment-text">Transferencia bancaria</div>
                </div>

                <div class="payment-option" onclick="selectPayment(this)">
                    <div class="payment-icon">üì±</div>
                    <div class="payment-text">SINPE m√≥vil</div>
                </div>

                <div class="payment-option" onclick="selectPayment(this)">
                    <div class="payment-icon">üíµ</div>
                    <div class="payment-text">Efectivo el d√≠a de la cita</div>
                </div>
            </div>

        
             <button class="continue-btn" 
                data-url="{{ url_for('routes.payment') }}" 
                onclick="continueToPaymentForm(this)">
                 Continuar
            </button>
        </div>

      <div id="calendarModal" class="modal-overlay hidden">
  <div class="modal-content">
    <h3>¬øDeseas agregar esta cita a tu calendario?</h3>
    <div class="modal-buttons">
      <button id="btnSiCalendario" class="btn-yes">S√≠</button>
      <button id="btnNoCalendario" class="btn-no">No</button>
    </div>
  </div>
</div>
    </main>

    <script src="{{ url_for('static', filename='js/payment-summary.js') }}"></script>
<script>
    // Variable global para guardar la opci√≥n seleccionada
    window.selectedPayment = 'Tarjeta de cr√©dito o d√©bito'; // por defecto

    // Funci√≥n para seleccionar pago
    window.selectPayment = function(element) {
        // Remover la clase 'selected' de todas las opciones
        document.querySelectorAll('.payment-option').forEach(option => {
            option.classList.remove('selected');
        });
        // Agregar la clase 'selected' al elemento clickeado
        element.classList.add('selected');

        // Guardar la opci√≥n seleccionada en la variable global
        window.selectedPayment = element.querySelector('.payment-text').innerText;
        console.log('M√©todo de pago seleccionado:', window.selectedPayment);
    }

    const dashboardUrl = "{{ url_for('routes.dashboard_Consultante') }}";
    function convertirFechaISO(fechaTexto) {
    // Mapa de meses
    const meses = {
        "enero": 0, "febrero": 1, "marzo": 2, "abril": 3, "mayo": 4, "junio": 5,
        "julio": 6, "agosto": 7, "septiembre": 8, "octubre": 9, "noviembre": 10, "diciembre": 11
    };

    try {
        // Acepta formatos como "lunes 25 de octubre de 2025" o "25 de octubre de 2025"
        const partes = fechaTexto.toLowerCase().split(" ");
        let dia, mes, a√±o;

        if (partes.length === 6) { // ejemplo: lunes 25 de octubre de 2025
            dia = parseInt(partes[1]);
            mes = meses[partes[3]];
            a√±o = parseInt(partes[5]);
        } else if (partes.length === 4) { // ejemplo: 25 de octubre de 2025
            dia = parseInt(partes[0]);
            mes = meses[partes[2]];
            a√±o = parseInt(partes[3]);
        } else {
            throw new Error("Formato no reconocido");
        }

        const fecha = new Date(a√±o, mes, dia);
        const yyyy = fecha.getFullYear();
        const mm = String(fecha.getMonth() + 1).padStart(2, "0");
        const dd = String(fecha.getDate()).padStart(2, "0");

        return `${yyyy}${mm}${dd}`;
    } catch (error) {
        console.error("Error al convertir fecha:", fechaTexto, error);
        return null;
    }
}


function formatearHoraICS(horaTexto) {
    // Acepta "08:30" o "8:30"
    const [h, m] = horaTexto.split(":").map(x => parseInt(x));
    return `${String(h).padStart(2, "0")}${String(m).padStart(2, "0")}00`;
}

const fechaSeleccionada = document.querySelector(".date-option.selected").dataset.fecha;

// Buscar el horario completo
const horario = JSON.parse(localStorage.getItem("horariosSeleccionados") || "{}")[idDisponibilidad];

// Guardar fecha y horas originales (por si se usan en otra parte)
localStorage.setItem("fechaCalendario", fechaSeleccionada);
localStorage.setItem("horaInicioCalendario", horario.hora_inicio);
localStorage.setItem("horaFinCalendario", horario.hora_fin);

// Convertir formato de fecha y hora al est√°ndar .ics (YYYYMMDDTHHmmss)
const fechaISO = convertirFechaISO(fechaSeleccionada);
const horaInicioISO = formatearHoraICS(horario.hora_inicio);
const horaFinISO = formatearHoraICS(horario.hora_fin);

// Guardar versi√≥n formateada para ICS
localStorage.setItem("fechaInicioICS", `${fechaISO}T${horaInicioISO}`);
localStorage.setItem("fechaFinICS", `${fechaISO}T${horaFinISO}`);

    function continueToPaymentForm() {
        // Tomar todos los datos del localStorage
        const usuario = "{{ session.get('idusuario') }}";
        const servicio = localStorage.getItem("selectedServiceId"); // id del servicio
        const iddisponibilidad = localStorage.getItem("idDisponibilidadSeleccionada");
        const estado = 0; // por defecto
        const pago = 1; // por defecto

        const citaData = {
            usuario,
            servicio: parseInt(servicio),
            iddisponibilidad: parseInt(iddisponibilidad),
            estado,
            pago 
        };

        if (window.selectedPayment === 'Tarjeta de cr√©dito o d√©bito') {
            // Redirigir a la pasarela de pago
            const paymentforUrl = "{{ url_for('routes.payment') }}";
            window.location.href = paymentforUrl;
        } else {
            // Enviar POST al backend
            fetch("{{ url_for('Citas.CrearCita') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(citaData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    const fechaISO = convertirFechaISO(data.fecha);
                    localStorage.setItem("fechaCalendario", fechaISO);
                    localStorage.setItem("horaInicioCalendario", data.hora_inicio);
                    localStorage.setItem("horaFinCalendario", data.hora_fin);

                    mostrarModalCalendario();
                    
                    
                }
            })
            .catch(err => console.error("Error al crear cita:", err));
        }
    }
</script>

{% endblock %}