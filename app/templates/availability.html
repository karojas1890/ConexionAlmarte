{% extends "layout_terapeuta.html" %}

{% block title %}Menu Principal{% endblock %}

{% block content %}
    
<div class="container">
  <div class="page-header">
      <h1 class="page-title">Disponibilidad de Horarios</h1>
      <p class="page-subtitle">Selecciona las fechas y horas en las que estarás disponible para atender pacientes</p>
  </div>

  <div class="content-grid">

      <!-- Calendario -->
      <div class="calendar-card">
          <div class="calendar-header">
              <h2 class="calendar-title" id="calendar-month">Noviembre 2025</h2>
              <div class="calendar-nav">
                  <button id="prev-month" class="nav-btn">&lt;</button>
                  <button id="next-month" class="nav-btn">&gt;</button>
              </div>
          </div>

          <div class="calendar">
              <div class="calendar-weekdays">
                  <div class="weekday">Dom</div>
                  <div class="weekday">Lun</div>
                  <div class="weekday">Mar</div>
                  <div class="weekday">Mié</div>
                  <div class="weekday">Jue</div>
                  <div class="weekday">Vie</div>
                  <div class="weekday">Sáb</div>
              </div>
              <div class="calendar-days" id="calendar-days">
                  <!-- Los días se generarán dinámicamente por JS -->
              </div>
          </div>
      </div>

      <!-- Slots de horario -->
      <div class="time-slots-card">
          <div class="slots-header">
              <h3 class="slots-title">Horarios Disponibles</h3>
              <p class="selected-date" id="selected-date">Seleccione un día</p>
          </div>

          <div class="time-slots-list" id="time-slots-list">
              <!-- Slots se cargarán dinámicamente -->
          </div>

          <button class="save-btn" id="save-slots-btn">Guardar Cambios</button>
      </div>
  </div>
</div>

<script>
let disponibilidadGlobal = {}; 
let nuevosSlots = [];
let fechaSeleccionada = null;

// Función para generar el calendario dinámico
function generarCalendario(year, month) {
    const calendarDays = document.getElementById("calendar-days");
    calendarDays.innerHTML = "";
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Rellenar días vacíos
    for(let i=0;i<firstDay;i++){
        const div = document.createElement("div");
        div.classList.add("day");
        calendarDays.appendChild(div);
    }

    // Rellenar días del mes
    for(let d=1; d<=daysInMonth; d++){
        const div = document.createElement("div");
        div.classList.add("day");
        div.innerHTML = `<span class="day-number">${d}</span>`;
        div.addEventListener("click", () => seleccionarDia(d, month, year, div));
        calendarDays.appendChild(div);
    }
}

// Selección de día
function seleccionarDia(d, month, year, divDia){
    document.querySelectorAll(".day").forEach(d => d.classList.remove("selected"));
    divDia.classList.add("selected");
    fechaSeleccionada = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    document.getElementById("selected-date").textContent = fechaSeleccionada;
    cargarSlots(fechaSeleccionada);
}

// Cargar slots para un día
async function cargarSlots(fecha){
    const slotsList = document.getElementById("time-slots-list");
    slotsList.innerHTML = "";
    nuevosSlots = [];

    // Si no tenemos datos, traer del backend
    if(!disponibilidadGlobal[fecha]){
        try{
            const res = await fetch("{{ url_for('Citas.ObtenerDisponibilidad') }}");
            const data = await res.json();
            disponibilidadGlobal = data.reduce((acc, slot) => {
                if(!acc[slot.fecha]) acc[slot.fecha] = [];
                acc[slot.fecha].push(slot);
                return acc;
            }, {});
        }catch(err){
            console.error(err);
        }
    }

    // Generar slots
    const slotsBase = [
        "08:00 - 09:00","09:00 - 10:00","10:00 - 11:00","11:00 - 12:00",
        "14:00 - 15:00","15:00 - 16:00","16:00 - 17:00","17:00 - 18:00"
    ];

    slotsBase.forEach(time => {
        const div = document.createElement("div");
        div.classList.add("time-slot");
        div.innerHTML = `
            <span class="slot-time">${time}</span>
            <div class="slot-toggle"></div>
        `;

        // Marcar si ya está ocupado
        const encontrado = (disponibilidadGlobal[fecha] || []).find(s => s.hora_inicio + " - " + s.hora_fin === time);
        if(encontrado){
            div.querySelector(".slot-toggle").classList.add("active");
            div.classList.add("occupied");
        }

        div.querySelector(".slot-toggle").addEventListener("click", function(){
            if(div.classList.contains("occupied")) return;
            this.classList.toggle("active");
            const [inicio, fin] = time.split(" - ");
            if(this.classList.contains("active")){
                nuevosSlots.push({hora_inicio: inicio, hora_fin: fin});
            }else{
                nuevosSlots = nuevosSlots.filter(s => !(s.hora_inicio===inicio && s.hora_fin===fin));
            }
        });

        slotsList.appendChild(div);
    });
}

// Guardar nuevos slots
document.getElementById("save-slots-btn").addEventListener("click", async ()=>{
    if(!fechaSeleccionada || nuevosSlots.length===0) return;
    try{
        await fetch("{{ url_for('availability.AgregarDisponibilidad') }}", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({slots: nuevosSlots})
        });
        alert("Disponibilidad guardada!");
        cargarSlots(fechaSeleccionada); // recargar para reflejar los ocupados
    }catch(err){console.error(err);}
});

// Inicializar calendario con mes actual
const hoy = new Date();
generarCalendario(hoy.getFullYear(), hoy.getMonth());
</script>

   
   {% endblock %}